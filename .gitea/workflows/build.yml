---
name: build
on:
  push:
    branches:
      - main

jobs:
  build:
    name: Building
    runs-on: ubuntu-latest
    container:
      image: git.ednz.fr/container-factory/packer-runner:act-latest
      credentials:
        username: ${{ secrets.ACTIONS_USER }}
        password: ${{ secrets.ACTIONS_TOKEN }}
    strategy:
      matrix:
        build_group: [ansible-runners]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Python dependencies
        uses: py-actions/py-dependency-install@v4
        with:
          path: "${{ gitea.workspace }}/requirements.txt"

      - name: Generate packer files
        run: factory generate --vault-login
        shell: bash
        working-directory: ${{ gitea.workspace }}
        env:
          VAULT_ADDR: https://vault.ednz.fr
          IMAGE_FACTORY_ENV: production
          IMAGE_FACTORY_INVENTORY: ${{ matrix.build_group }}
          IMAGE_FACTORY_VAULT_APPROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          IMAGE_FACTORY_VAULT_APPROLE_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}

      - name: Ensure packer files are generated
        run: tree
        shell: bash
        working-directory: ${{ gitea.workspace }}/packer/builds
