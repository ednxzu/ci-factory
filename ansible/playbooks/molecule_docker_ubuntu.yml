---
- name: "Molecule docker ubuntu"
  hosts: "{{ target_host }}"
  gather_facts: true
  become: no
  tasks:
    - name: "Include ednxzu.manage_repositories"
      ansible.builtin.include_role:
        name: ednxzu.manage_repositories

    - name: "Include ednxzu.manage_apt_packages"
      ansible.builtin.include_role:
        name: ednxzu.manage_apt_packages

    - name: Comment out imklog in rsyslog.conf
      ansible.builtin.replace:
        path: /etc/rsyslog.conf
        regexp: '^\($ModLoad imklog\)'
        replace: '#$ModLoad imklog'

    - name: "Copy initctl_faker script"
      ansible.builtin.copy:
        src: "{{ factory['root_dir'] }}/ansible/inventory/production/group_files/{{ flavor }}_{{ builder }}_{{ base }}/initctl_faker"
        dest: /initctl_faker
        owner: root
        group: root
        mode: '0755'

    - name: "Remove original /sbin/initctl"
      ansible.builtin.file:
        path: /sbin/initctl
        state: absent

    - name: "Symlink initctl_faker"
      ansible.builtin.file:
        src: /initctl_faker
        dest: /sbin/initctl
        owner: root
        group: root
        state: link

    - name: "Generate the en_US.UTF-8 locale"
      ansible.builtin.command: locale-gen en_US.UTF-8

    - name: "Include ednxzu.manage_pip_packages"
      ansible.builtin.include_role:
        name: ednxzu.manage_pip_packages

    - name: "Ensure /etc/ansible directory exists"
      ansible.builtin.file:
        path: /etc/ansible
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "Copy ansible hosts file"
      ansible.builtin.copy:
        src: "{{ factory['root_dir'] }}/ansible/inventory/production/group_files/{{ flavor }}_{{ builder }}_{{ base }}/hosts"
        dest: /etc/ansible/hosts
        owner: root
        group: root
        mode: '0644'

    - name: "Finds files udev targets"
      ansible.builtin.find:
        paths: "/lib/systemd/system/"
        patterns: "systemd*udev*"
        recurse: yes
        use_regex: yes
      register: _udev_targets

    - name: "Debug"
      ansible.builtin.debug:
        msg: "{{ _udev_targets.files }}"

    - name: "Remove udev targets"
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      with_items: "{{ _udev_targets.files }}"

    - name: "Remove getty targets"
      file:
        path: /lib/systemd/system/getty.target
        state: absent

    - name: "Include cleanup tasks"
      ansible.builtin.include_tasks:
        file: "tasks/cleanup_docker.yml"
